# Task Manager Bot - Архитектура системы

## Схема архитектуры

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           TELEGRAM ECOSYSTEM                                │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  👤 Пользователи          📱 Чат поддержки         🏢 Форумный чат          │
│  ┌─────────────┐         ┌─────────────────┐      ┌─────────────────┐       │
│  │ Личные чаты │         │ Агенты поддержки│      │ Темы по статусам│       │
│  │ Групповые   │  ────►  │ Исполнители     │ ───► │ Темы исполнителей│      │
│  │ чаты        │         │ Администраторы  │      │ Пользовательские│       │
│  └─────────────┘         └─────────────────┘      │ темы            │       │
│         │                         │               └─────────────────┘       │
│         │                         │                         │               │
└─────────┼─────────────────────────┼─────────────────────────┼───────────────┘
          │                         │                         │
          ▼                         ▼                         ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                              BOT LAYER                                      │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  🤖 UserBot              🎯 TaskBot               🔄 MoverBot               │
│  ┌─────────────┐        ┌─────────────┐         ┌─────────────┐            │
│  │• Получает   │        │• Создаёт    │         │• Перемещает │            │
│  │  сообщения  │        │  задачи     │         │  задачи     │            │
│  │• Создаёт    │        │• Обновляет  │         │• Управляет  │            │
│  │  задачи     │        │  статистику │         │  клавиатурой│            │
│  │• Ставит     │        │• Показывает │         │• Сохраняет  │            │
│  │  реакции    │        │  главное    │         │  ответы     │            │
│  │• Пересылает │        │  меню       │         │• Создаёт    │            │
│  │  ответы     │        │             │         │  темы       │            │
│  └─────────────┘        └─────────────┘         └─────────────┘            │
│         │                         │                         │               │
│         │                         │                         │               │
└─────────┼─────────────────────────┼─────────────────────────┼───────────────┘
          │                         │                         │
          ▼                         ▼                         ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                           COMMUNICATION LAYER                               │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│                        📡 Redis PubSub                                     │
│                    ┌─────────────────────┐                                 │
│                    │  Каналы событий:    │                                 │
│                    │  • new_tasks        │                                 │
│                    │  • task_updates     │                                 │
│                    │  • status_change    │                                 │
│                    │  • new_reply        │                                 │
│                    │  • task_deleted     │                                 │
│                    └─────────────────────┘                                 │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                             DATA LAYER                                      │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│                          🗄️ Redis Database                                 │
│                    ┌─────────────────────┐                                 │
│                    │ Структуры данных:   │                                 │
│                    │ • task:{id}         │ ← Данные задач                  │
│                    │ • counter:*         │ ← Счётчики статистики           │
│                    │ • user_topic:*      │ ← Темы пользователей            │
│                    │ • topic_user:*      │ ← Обратная связь тем            │
│                    │ • system_topics     │ ← Системные темы                │
│                    │ • executor_topics   │ ← Темы исполнителей             │
│                    │ • pinned_message    │ ← ID закреплённого сообщения    │
│                    └─────────────────────┘                                 │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

## Поток данных

### 1. Создание задачи
```
Пользователь пишет сообщение
         ↓
    UserBot получает
         ↓
   Создаёт задачу в Redis
         ↓
  Публикует событие new_tasks
         ↓
    TaskBot получает событие
         ↓
   Обновляет статистику
         ↓
  Публикует событие task_updates
         ↓
    MoverBot получает событие
         ↓
  Перемещает в тему "неотреагированные"
```

### 2. Взятие задачи в работу
```
Агент нажимает "В работу"
         ↓
    MoverBot обрабатывает
         ↓
   Меняет статус на in_progress
         ↓
  Публикует событие status_change
         ↓
    UserBot получает событие
         ↓
    Ставит реакцию ⚡
         ↓
    MoverBot перемещает в тему исполнителя
```

### 3. Ответ поддержки
```
Агент нажимает "Ответить"
         ↓
    MoverBot запускает FSM
         ↓
   Агент вводит ответ
         ↓
  MoverBot сохраняет ответ
         ↓
  Публикует событие new_reply
         ↓
    UserBot получает событие
         ↓
  Пересылает ответ пользователю
         ↓
  Пересылает в тему пользователя
```

### 4. Завершение задачи
```
Агент нажимает "Завершить"
         ↓
    MoverBot меняет статус
         ↓
  Публикует событие status_change
         ↓
    UserBot ставит реакцию 👌
         ↓
    MoverBot перемещает в "Завершённые"
         ↓
    TaskBot обновляет статистику
```

## Ключевые особенности

### 🔄 Асинхронная связь
- Все боты общаются через Redis PubSub
- Нет прямых вызовов между ботами
- Каждый бот может работать независимо

### 📊 Централизованные данные
- Все данные хранятся в Redis
- Единая точка истины для задач и статистики
- Быстрый доступ к данным

### 🎯 Разделение ответственности
- **UserBot**: Работа с пользователями, реакции, пересылка
- **TaskBot**: Статистика, главное меню, создание задач
- **MoverBot**: Перемещение задач, клавиатуры, ответы поддержки

### 🔧 Масштабируемость
- Легко добавить новых ботов
- Можно запускать несколько экземпляров
- Горизонтальное масштабирование через Redis
