# Telegram Task Manager

Комплексная система управления задачами в Telegram с использованием Redis и трех специализированных ботов.

## Обзор системы

Система состоит из трех взаимодействующих ботов:

1. **User Bot** - собирает сообщения пользователей и создает задачи
2. **Task Bot** - управляет задачами в чате поддержки
3. **Mover Bot** - перемещает задачи и ведет статистику

## Новые функции

### 🎯 Темы для каждого пользователя
- Каждый пользователь получает отдельную тему в форуме поддержки
- Все обсуждения и ответы группируются в персональной теме
- Автоматическое создание и управление темами

### ⏱️ Автообъединение сообщений
- Сообщения от одного пользователя объединяются в течение 5 минут
- Предотвращает создание множества мелких задач
- Настраиваемый таймаут агрегации

### 📊 Расширенная статистика
- Детальная аналитика по исполнителям
- Дневная статистика создания задач
- Автоматическое перемещение завершенных задач в архив

## Архитектура

```
┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│  User Bot   │    │  Task Bot   │    │ Mover Bot   │
│             │    │             │    │             │
│ • Сбор      │    │ • Обработка │    │ • Статистика│
│   сообщений │    │   задач     │    │ • Перемещение│
│ • Агрегация │    │ • Кнопки    │    │ • Очистка   │
│ • Темы      │    │ • Ответы    │    │ • Архив     │
└─────────────┘    └─────────────┘    └─────────────┘
       │                   │                   │
       └───────────────────┼───────────────────┘
                           │
                    ┌─────────────┐
                    │    Redis    │
                    │             │
                    │ • Pub/Sub   │
                    │ • Данные    │
                    │ • Счетчики  │
                    └─────────────┘
```

## Быстрый старт

### 1. Установка зависимостей

```bash
pip install -r requirements.txt
```

### 2. Настройка окружения

Создайте файл `.env`:

```env
# Токены ботов
USER_BOT_TOKEN=your_user_bot_token
TASK_BOT_TOKEN=your_task_bot_token
MOVER_BOT_TOKEN=your_mover_bot_token

# Чаты
FORUM_CHAT_ID=-1002269851341
SUPPORT_CHAT_ID=-1002269851341

# Redis
REDIS_HOST=localhost
REDIS_PORT=6379
REDIS_DB=0

# Настройки
MESSAGE_AGGREGATION_TIMEOUT=300
WAITING_TOPIC_ID=1
COMPLETED_TOPIC_ID=3
```

### 3. Запуск Redis

```bash
# Используя Docker
docker run -d -p 6379:6379 redis:alpine

# Или локально
redis-server core/redis.conf
```

### 4. Запуск системы

```bash
# Запуск всей системы одной командой
python main.py

# Или запуск отдельных ботов
python main.py --only user        # Только User Bot
python main.py --only task        # Только Task Bot
python main.py --only mover       # Только Mover Bot

# С отладочными логами
python main.py --debug

# Альтернативный запуск отдельных ботов
python -m bots.user_bot.main
python -m bots.task_bot.main
python -m bots.mover_bot.main
```

## Структура проекта

```
manager/
├── bots/
│   ├── user_bot/
│   │   ├── user_bot.py           # Основной бот
│   │   ├── topic_manager.py      # Управление темами
│   │   ├── message_aggregator.py # Агрегация сообщений
│   │   ├── main.py              # Точка входа
│   │   └── README.md            # Документация
│   │
│   ├── task_bot/
│   │   ├── task_bot.py          # Основной бот
│   │   ├── redis_manager.py     # Работа с Redis
│   │   ├── pubsub_manager.py    # Pub/Sub события
│   │   ├── formatters.py        # Форматирование сообщений
│   │   ├── keyboards.py         # Клавиатуры
│   │   ├── main.py             # Точка входа
│   │   └── README.md           # Документация
│   │
│   └── mover_bot/
│       ├── mover_bot.py         # Основной бот
│       ├── main.py             # Точка входа
│       └── README.md           # Документация
│
├── config/
│   └── settings.py              # Настройки системы
│
├── core/
│   ├── models.py               # Модели данных
│   ├── redis_client.py         # Redis клиент
│   └── redis.conf              # Конфигурация Redis
│
├── logs/                       # Логи системы
├── .env                        # Переменные окружения
├── main.py                     # Главный файл запуска
└── README.md                   # Этот файл
```

## Workflow системы

### 1. Создание задачи

```
Пользователь → User Bot → Агрегация → Redis → Task Bot → Чат поддержки
```

1. Пользователь отправляет сообщение User Bot
2. Сообщение добавляется в очередь агрегации (5 минут)
3. Создается объединенная задача в Redis
4. Task Bot получает уведомление и публикует в чат поддержки
5. Создается персональная тема пользователя в форуме

### 2. Обработка задачи

```
Поддержка → Кнопки → Task Bot → Redis → User Bot → Пользователь
```

1. Сотрудник поддержки нажимает кнопку (взять в работу, завершить)
2. Task Bot обновляет статус в Redis
3. User Bot получает уведомление и обновляет реакции
4. При ответе - сообщение отправляется пользователю

### 3. Архивирование

```
Завершение → Task Bot → Redis → Mover Bot → Архивная тема
```

1. Задача помечается как завершенная
2. Mover Bot получает уведомление
3. Сообщение перемещается в архивную тему
4. Обновляется статистика

## Основные функции

### User Bot
- ✅ Сбор сообщений от пользователей
- ✅ Автообъединение сообщений (5 минут)
- ✅ Создание персональных тем
- ✅ Отправка ответов пользователям
- ✅ Реакции для обратной связи

### Task Bot
- ✅ Интерактивные кнопки управления
- ✅ Система статусов (unreacted → waiting → in_progress → completed)
- ✅ FSM для ответов на задачи
- ✅ Система напоминаний
- ✅ Автоматическая нумерация задач

### Mover Bot
- ✅ Автоматическое перемещение завершенных задач
- ✅ Детальная статистика по исполнителям
- ✅ Управление темами форума
- ✅ Очистка старых данных

## Мониторинг и логирование

### Логи
Все боты ведут подробные логи:
- `logs/user_bot.log` - события User Bot
- `logs/task_bot.log` - события Task Bot  
- `logs/mover_bot.log` - события Mover Bot
- `logs/*_errors.log` - только ошибки

### Метрики
- Количество обработанных сообщений
- Статистика по статусам задач
- Производительность исполнителей
- Время отклика системы

### Команды мониторинга

```bash
# Статистика задач
/stats в Mover Bot

# Проверка Redis
redis-cli info

# Просмотр логов
tail -f logs/task_bot.log
```

## Настройка и конфигурация

### Переменные окружения

| Переменная | Описание | По умолчанию |
|------------|----------|--------------|
| `USER_BOT_TOKEN` | Токен User Bot | - |
| `TASK_BOT_TOKEN` | Токен Task Bot | - |
| `MOVER_BOT_TOKEN` | Токен Mover Bot | - |
| `FORUM_CHAT_ID` | ID форума | - |
| `SUPPORT_CHAT_ID` | ID чата поддержки | - |
| `MESSAGE_AGGREGATION_TIMEOUT` | Таймаут агрегации (сек) | 300 |
| `STATS_UPDATE_INTERVAL` | Интервал статистики (сек) | 30 |
| `WAITING_TOPIC_ID` | ID темы ожидающих | 1 |
| `COMPLETED_TOPIC_ID` | ID темы завершенных | 3 |

### Redis конфигурация

```bash
# Основные настройки в core/redis.conf
port 6379
bind 127.0.0.1
maxmemory 256mb
maxmemory-policy allkeys-lru
```

## Развертывание

### Docker Compose

```yaml
version: '3.8'
services:
  redis:
    image: redis:alpine
    ports:
      - "6379:6379"
    volumes:
      - ./core/redis.conf:/usr/local/etc/redis/redis.conf
    command: redis-server /usr/local/etc/redis/redis.conf

  user-bot:
    build: .
    command: python -m bots.user_bot.main
    depends_on:
      - redis
    env_file:
      - .env

  task-bot:
    build: .
    command: python -m bots.task_bot.main
    depends_on:
      - redis
    env_file:
      - .env

  mover-bot:
    build: .
    command: python -m bots.mover_bot.main
    depends_on:
      - redis
    env_file:
      - .env
```

### Systemd сервисы

```bash
# Создание сервисов
sudo cp scripts/*.service /etc/systemd/system/
sudo systemctl daemon-reload
sudo systemctl enable task-manager-*
sudo systemctl start task-manager-*
```

## Безопасность

- Все токены хранятся в переменных окружения
- Redis настроен только для локального доступа
- Логирование всех операций
- Валидация входных данных
- Ограничение прав ботов

## Производительность

### Оптимизации
- Асинхронная обработка всех операций
- Пулы соединений для Redis
- Кэширование часто используемых данных
- Пакетная обработка задач

### Рекомендации
- Используйте SSD для Redis
- Настройте мониторинг памяти
- Регулярно очищайте старые данные
- Мониторьте размер логов

## Устранение неполадок

### Частые проблемы

1. **Боты не отвечают**
   - Проверьте токены в `.env`
   - Убедитесь что боты добавлены в чаты
   - Проверьте подключение к Redis

2. **Задачи не создаются**
   - Проверьте логи User Bot
   - Убедитесь что Redis запущен
   - Проверьте права ботов в чатах

3. **Статистика не обновляется**
   - Перезапустите Mover Bot
   - Проверьте Redis Pub/Sub
   - Убедитесь в корректности CHAT_ID

### Диагностика

```bash
# Проверка Redis
redis-cli ping

# Проверка подключений
redis-cli client list

# Проверка данных
redis-cli keys "task:*" | wc -l

# Проверка Pub/Sub
redis-cli monitor
```

## Разработка

### Требования
- Python 3.8+
- Redis 6.0+
- aiogram 3.x
- aioredis 2.x

### Тестирование

```bash
# Запуск тестов
python -m pytest tests/

# Проверка покрытия
python -m pytest --cov=bots tests/

# Линтинг
flake8 bots/
black bots/
```

### Вклад в проект

1. Форкните репозиторий
2. Создайте ветку для функции
3. Добавьте тесты
4. Убедитесь что все тесты проходят
5. Создайте Pull Request

## Лицензия

MIT License - см. файл LICENSE

## Поддержка

- GitHub Issues для багов и предложений
- Документация в README файлах каждого бота
- Примеры использования в папке examples/

---

**Версия**: 2.0.0  
**Последнее обновление**: 30.01.2025  
**Авторы**: Task Manager Team
